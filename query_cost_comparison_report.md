# PostgreSQL クエリコスト比較レポート

## テスト環境
- PostgreSQL 16.11
- 在庫テーブル: 1,000万件（100ハッシュパーティション）
- マスタテーブル: 可変件数（パーティションなし）

## テーブル構造

### 在庫テーブル (inventory)
```sql
CREATE TABLE inventory (
    store_id INTEGER NOT NULL,      -- 店舗ID
    product_id INTEGER NOT NULL,    -- 商品ID
    stock_quantity INTEGER NOT NULL, -- 在庫数
    PRIMARY KEY (store_id, product_id)
) PARTITION BY HASH (store_id);
-- 100個のハッシュパーティション
-- データ件数: 1,000万件（1,000店舗 × 10,000商品）
```

### マスタテーブル (product_master)
```sql
CREATE TABLE product_master (
    store_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    product_name VARCHAR(100) NOT NULL,
    PRIMARY KEY (store_id, product_id)
);
-- パーティションなし
```

## テスト結果

### コスト・実行時間比較

| マスタ件数 | 単体SELECT コスト | JOIN コスト | コスト倍率 | SELECT時間(ms) | JOIN時間(ms) | 時間倍率 |
|----------:|------------------:|------------:|-----------:|---------------:|-------------:|---------:|
| 1万 | 204,101 | 1,410 | **0.01** | 2,549 | 15 | **0.01** |
| 5万 | 204,101 | 6,781 | **0.03** | 2,549 | 36 | **0.01** |
| 10万 | 204,101 | 13,495 | **0.07** | 2,549 | 64 | **0.03** |
| 50万 | 204,101 | 70,191 | **0.34** | 2,549 | 365 | **0.14** |
| 100万 | 204,101 | 137,323 | **0.67** | 2,549 | 658 | **0.26** |
| 200万 | 204,101 | 274,802 | 1.35 | 2,549 | 1,969 | **0.77** |
| 500万 | 204,101 | 569,701 | 2.79 | 2,549 | 10,897 | 4.27 |
| 1,000万 | 204,101 | 785,137 | 3.85 | 2,549 | 13,309 | 5.22 |

※ 太字はJOINが有利な値

### 閾値分析

| 指標 | 閾値（推定） | 説明 |
|-----|----------:|-----|
| **コスト等価点** | **約148万件** | これ以下ならJOINのコストが低い |
| **時間等価点** | **約219万件** | これ以下ならJOINの実行時間が短い |

## 結論

### マスタが**100万件以下**の場合
- **JOINを使った方が有利**
- コスト: JOINは単体SELECTの67%以下
- 実行時間: JOINは単体SELECTの26%以下

### マスタが**100万〜200万件**の場合
- **JOINでもほぼ同等（やや有利）**
- コストはSELECTより高くなるが、実行時間はまだJOINが速い
- 時間倍率: 0.77（JOINが23%速い）

### マスタが**200万件以上**の場合
- **単体SELECTの方が有利**
- 特に500万件以上では、JOINは4〜5倍遅くなる

## 重要な注意点

1. **JOIN結果の行数に依存**: このテストでは、マスタに存在するデータのみがJOIN結果として返されます。マスタが少なければ結果も少なくなるため、JOINが有利になります。

2. **全件取得の場合**: 在庫テーブルの全データを取得したい場合（マスタ1,000万件=在庫全件カバー）、JOINは約3.85倍のコスト、5.22倍の実行時間がかかります。

3. **実行計画**: マスタ1,000万件の場合、Hash Joinが選択され、マスタテーブル全体をハッシュテーブルに読み込むコストが発生します。

## 推奨

| ユースケース | 推奨 |
|-------------|------|
| 特定の商品のみ取得（絞り込み目的） | JOIN推奨 |
| マスタが100万件以下 | JOIN推奨 |
| マスタが200万件以上で全件取得 | 単体SELECT → アプリ側でマスタ参照 |
| リアルタイム性重視 | 単体SELECT（実行時間が安定） |
